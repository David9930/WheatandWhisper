// =============================================================================
// FILE: cat-box-loader.js
// MODIFIED: 2025-02-07 - AUTO-INDEX VERSION
// PURPOSE: Loads products from products-index.json (auto-generated by build)
// =============================================================================

// Main initialization
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üõçÔ∏è Category page loader starting...');
    
    const boxNumber = window.CATEGORY_BOX_NUMBER;
    console.log(`üì¶ Loading products for Category Box ${boxNumber}`);
    
    await loadCategoryInfo(boxNumber);
    await loadProducts(boxNumber);
});

// Load category name and emoji from shop-settings.md
async function loadCategoryInfo(boxNumber) {
    try {
        const response = await fetch('content/pages/shop-settings.md');
        const text = await response.text();
        
        const categoryKey = `category_box_${boxNumber}`;
        const categoryMatch = text.match(new RegExp(`${categoryKey}:[\\s\\S]*?title:\\s*(.+?)\\s*\\n[\\s\\S]*?emoji:\\s*(.+?)\\s*\\n`, 'i'));
        
        if (categoryMatch) {
            const categoryTitle = categoryMatch[1].trim();
            const categoryEmoji = categoryMatch[2].trim();
            
            const pageTitleElement = document.querySelector('title');
            const categoryNameElement = document.getElementById('category-name');
            const categoryEmojiElement = document.getElementById('category-emoji');
            const breadcrumbElement = document.getElementById('breadcrumb-category');
            
            if (pageTitleElement) pageTitleElement.textContent = `${categoryTitle} - Wheat and Whisper Farm`;
            if (categoryNameElement) categoryNameElement.textContent = categoryTitle;
            if (categoryEmojiElement) categoryEmojiElement.textContent = categoryEmoji;
            if (breadcrumbElement) breadcrumbElement.textContent = categoryTitle;
            
            console.log(`‚úÖ Category info loaded: ${categoryEmoji} ${categoryTitle}`);
        } else {
            console.warn(`‚ö†Ô∏è No category info found for Box ${boxNumber}`);
            const categoryNameElement = document.getElementById('category-name');
            if (categoryNameElement) categoryNameElement.textContent = `Category ${boxNumber}`;
        }
    } catch (error) {
        console.error('Error loading category info:', error);
        const categoryNameElement = document.getElementById('category-name');
        if (categoryNameElement) categoryNameElement.textContent = `Category ${boxNumber}`;
    }
}

// Load products from auto-generated index
async function loadProducts(boxNumber) {
    const container = document.getElementById('products-container');
    const emptyState = document.getElementById('empty-state');
    const categoryCount = document.getElementById('category-count');
    
    if (!container) {
        console.error('‚ùå Products container not found!');
        return;
    }
    
    try {
        // Fetch the auto-generated product index
        const indexResponse = await fetch('products-index.json');
        if (!indexResponse.ok) {
            throw new Error('Could not load products-index.json');
        }
        
        const PRODUCT_FILES = await indexResponse.json();
        console.log(`üìÇ Loaded index with ${PRODUCT_FILES.length} products`);
        
        // Load each product file
        const products = [];
        for (const filename of PRODUCT_FILES) {
            try {
                const filepath = `content/products/${filename}.md`;
                const response = await fetch(filepath);
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è Could not load ${filepath}: ${response.status}`);
                    continue;
                }
                
                const text = await response.text();
                const product = parseProduct(text, filename);
                
                // Filter by category_box and availability
                if (product.category_box === boxNumber.toString() && product.available !== false) {
                    products.push(product);
                    console.log(`‚úÖ Loaded: ${product.title} (Box ${product.category_box})`);
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è Error loading ${filename}:`, error);
            }
        }
        
        console.log(`‚úÖ Found ${products.length} products for Box ${boxNumber}`);
        
        // Display products
        if (products.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'block';
            if (categoryCount) categoryCount.textContent = 'No products available';
        } else {
            container.innerHTML = '';
            if (categoryCount) categoryCount.textContent = `${products.length} ${products.length === 1 ? 'product' : 'products'}`;
            
            products.sort((a, b) => (a.order || 100) - (b.order || 100));
            
            products.forEach(product => {
                const card = createProductCard(product);
                container.appendChild(card);
            });
            
            if (emptyState) emptyState.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading products:', error);
        container.innerHTML = '<div class="error-message"><p>Error loading products. Please try again later.</p></div>';
    }
}

// Parse product markdown file
function parseProduct(text, filename) {
    const product = {
        filename: filename,
        slug: filename
    };
    
    const frontMatterMatch = text.match(/^---\s*\n([\s\S]*?)\n---/);
    if (!frontMatterMatch) {
        console.warn(`‚ö†Ô∏è No front matter in ${filename}`);
        return product;
    }
    
    const frontMatter = frontMatterMatch[1];
    const lines = frontMatter.split('\n');
    
    lines.forEach(line => {
        const match = line.match(/^\s*(\w+):\s*(.+)$/);
        if (match) {
            const key = match[1];
            let value = match[2].trim();
            
            value = value.replace(/^["']|["']$/g, '');
            
            if (value === 'true') value = true;
            else if (value === 'false') value = false;
            else if (key === 'order' || key === 'stock') value = parseInt(value) || 0;
            else if (key === 'price' || key === 'weight') {
                value = parseFloat(value.replace(/[$,]/g, '')) || 0;
            }
            
            product[key] = value;
        }
    });
    
    const bodyMatch = text.match(/---[\s\S]*?---\s*\n([\s\S]*)/);
    if (bodyMatch) {
        product.body = bodyMatch[1].trim();
    }
    
    return product;
}

// Create product card HTML
function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.style.cursor = 'pointer';
    
    let stockBadge = '';
    if (product.stock === 0) {
        stockBadge = '<span class="stock-badge sold-out">Sold Out</span>';
    } else if (product.stock && product.stock <= 3) {
        stockBadge = `<span class="stock-badge low-stock">Only ${product.stock} left!</span>`;
    }
    
    const featuredBadge = product.featured ? '<span class="featured-badge">‚≠ê Featured</span>' : '';
    const productImage = product.image || 'images/uploads/placeholder-product.jpg';
    
    card.innerHTML = `
        <div class="product-image">
            <img src="${productImage}" alt="${product.title || 'Product'}" onerror="this.src='images/uploads/placeholder-product.jpg'">
            ${stockBadge}
            ${featuredBadge}
        </div>
        <div class="product-info">
            <h3 class="product-title">${product.title || 'Untitled Product'}</h3>
            <p class="product-description">${product.short_description || ''}</p>
            <div class="product-footer">
                <span class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</span>
                <button class="view-details-btn">View Details ‚Üí</button>
            </div>
        </div>
    `;
    
    card.addEventListener('click', function(e) {
        window.location.href = `product-detail.html?product=${product.slug}`;
    });
    
    return card;
}

console.log('‚úÖ Category box loader ready (auto-index mode)');
